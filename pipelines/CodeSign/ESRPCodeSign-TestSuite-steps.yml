parameters:
  extRepoUrl : ''
  extRepoDir : ''
  HelperBranch : 'master'

steps:
  - task: CopyFiles@2
    displayName: 'Copy TestSuite'
    inputs:
      SourceFolder: '$(Build.Repository.LocalPath)'
      TargetFolder: '$(Build.BinariesDirectory)'

  - script: 'git clone -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" -b %HelperBranch% %EXTREPO_URL% %EXTREPO_DIR% 2>&1'
    displayName: 'Fetch external repo'
    env:
      EXTREPO_URL: ${{parameters.extRepoUrl}}
      EXTREPO_DIR: ${{parameters.extRepoDir}}
      HelperBranch: ${{parameters.HelperBranch}}
    timeoutInMinutes: 0

  - task: CopyFiles@2
    displayName: 'Copy CodeSign files'
    inputs:
      SourceFolder: '${{parameters.extRepoDir}}/CodeSign'
      TargetFolder: '$(Build.BinariesDirectory)/CodeSign'

  - task: CopyFiles@2
    displayName: 'Copy RDMA'
    inputs:
      SourceFolder: '${{parameters.extRepoDir}}/ProtoSDK/RDMA'
      TargetFolder: '$(Build.BinariesDirectory)/ProtoSDK/RDMA'

  - task: PowerShell@2
    displayName: 'Run code sign script'
    inputs:
      targetType: filePath
      filePath: '$(Build.BinariesDirectory)/CodeSign/Execute-SignTestSuites.ps1'
      arguments: '-TestSuiteName $(test.testSuiteName)'
      workingDirectory: '$(Build.BinariesDirectory)/CodeSign'