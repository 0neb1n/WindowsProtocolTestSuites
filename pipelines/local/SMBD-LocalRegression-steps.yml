parameters:
  extRepoUrl : ''
  extRepoDir : ''
  HelperBranch : ''
  BuildShareFolder : ''
  RootSharePath : ''
  
jobs:
- job:
  displayName: Run regression
  pool: 
    name: TestSuiteBuildPool
  workspace:
    clean: false
  timeoutInMinutes: 0

  steps:
    - script: 'git clone -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" -b %HelperBranch% %EXTREPO_URL% %EXTREPO_DIR% 2>&1'
      displayName: 'Fetch external repo'
      env:
        EXTREPO_URL: ${{parameters.extRepoUrl}}
        EXTREPO_DIR: ${{parameters.extRepoDir}}
        HelperBranch: ${{parameters.HelperBranch}}
      timeoutInMinutes: 0

    - task: PowerShell@2
      displayName: 'Copy LabScript To TestSuite'
      inputs:
        targetType: filePath
        filePath: '$(extRepo.dir)/CopyLabScriptToTestSuite.ps1'
      timeoutInMinutes: 0

    - task: BatchScript@1
      displayName: 'build MS-SMBD'
      inputs:
        filename: 'TestSuites/MS-SMBD/src/build.cmd'
      condition: eq(variables['test.sourceBuildTag'], '')

    - task: CopyFiles@2
      displayName: 'Copy Sign drop to: drop folder'
      inputs:
        SourceFolder: '$(build.sharePath)/$(test.sourceBuildTag)'
        TargetFolder: '$(Build.SourcesDirectory)/drop'
      condition: ne(variables['test.sourceBuildTag'], '')

    - task: PowerShell@2
      displayName: 'Copy TestSuite To Share'
      inputs:
        targetType: filePath
        filePath: '$(extRepo.dir)/CommonScript/CopyTestSuiteToShare.ps1'
        arguments: '-TestSuite MS-SMBD -TestSuiteShareFolder $(Build.StagingDirectory)\ProtocolTestSuite'
        errorActionPreference: continue
      timeoutInMinutes: 0

    - task: PowerShell@2
      displayName: 'Run test'
      env:
          MAIL_User: $(smtp.senderUsername)
          MAIL_PWD: $(smtp.senderPassword)
          BUILD_BUILDID: $(Build.BuildId)
          SOURCE_BUILDTAG: $(test.sourceBuildTag)
          HelperBranch: ${{parameters.HelperBranch}}
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          ApiUrl: $(build.apiUrl)
      inputs:
        targetType: 'inline'
        script: |
          [System.dateTime]::UtcNow.ToString("MM/dd/yyyy HH:mm:ss") | Out-File '$(Common.TestResultsDirectory)\StartTime.txt' -Encoding utf8 -Force
          $(extRepo.dir)\TestSuites\MS-SMBD\Setup\Scripts\Execute-ProtocolTest.ps1 -SharedPath $(Build.StagingDirectory) -MachineName "SMBD-Driver" -EnvironmentName Chelsio -TestResultPath $(Common.TestResultsDirectory)
          $(extRepo.dir)\TestSuites\MS-SMBD\Setup\Scripts\Execute-ProtocolTest.ps1 -SharedPath $(Build.StagingDirectory) -MachineName "SMBD-Driver" -EnvironmentName Mellanox -TestResultPath $(Common.TestResultsDirectory)
          $(extRepo.dir)\TestSuites\MS-SMBD\Setup\Scripts\Generate-Report.ps1 -TestResultPath $(Common.TestResultsDirectory)
        workingDirectory: '$(extRepo.dir)'
        errorActionPreference: continue

    - task: PublishTestResults@2
      displayName: 'Publish trx files'
      inputs:
        testResultsFormat: VSTest
        testResultsFiles: '$(Common.TestResultsDirectory)/*.trx'
      timeoutInMinutes: 0

    - task: PublishBuildArtifacts@1
      displayName: 'Publish report'
      inputs:
        PathtoPublish: '$(Common.TestResultsDirectory)'
      timeoutInMinutes: 0


